# 消息系统解决方案v2
## 需求
1. 买家卖家即时通讯界面
	1. 需要保证消息的即时性与准确性
	2. 消息历史记录加载
	3. 可以便捷发送当前商品 next.
2. 消息列表
	1. 需要记录所有有过沟通的人
	2. 消息列表可以删除
3. 作为不同身份时，拥有不同窗口？出于易于实现以及用户的观感，还是使用窗口比较好

## 现状
目前消息的同步就有服务器和客户端建立webSocket连接一个方法，如果转发失败，没有客户端主动的来取过程。
消息的持久化，现在异步的存储到数据库中，不影响消息的延迟。但是消息作为比较零散的内容，会导致频繁读写数据库，给数据库造成较大压力。
现在还没有实现消息列表功能，需要更多的数据表的设计。

## 解决方案Draft
### 消息持久化
消息持久化非常重要，因为没有客户端的情况下，所有消息都必须保存在服务端。单条聊天消息的体积往往非常小，但是数量却非常大，在这种情况下，单纯的存储在关系型数据库会造成频繁的读写，非常影响性能。另外，聊天消息不像订单等信息需要很强的可靠性保证。在上述场景下，我计划使用Redis+MySQL的存储方案，一般的聊天消息到达服务端，存到Redis的sortedList之中，比如暂存100条，或者近十天的消息，之后，也存储到数据库中，保证消息持久化的可靠性。同时，设置定时任务，删除过期的聊天记录，释放存储空间。

### 消息列表
消息列表比较简单实现，简单来说可以在redis中维持一个zList来存储，方便快速更新，因为数量有限，所以直接存储在数据库中也是可取的。根据用户最后发送或者接收到的消息，更新最后联系时间，按时间排序返回。

### 消息可靠性保证
todo

### 参考文章：
[现代IM系统中聊天消息的同步和存储方案探讨 - 知乎](https://zhuanlan.zhihu.com/p/31377253)
[IM系统海量消息数据是怎么存储的？ – 云聊IM](http://www.yunliaoim.com/im/1155.html)
[一个海量在线用户即时通讯系统（IM）的完整设计 – 云聊IM](http://www.yunliaoim.com/im/1075.html)
[自研IM系统存储设计 - 简书](https://www.jianshu.com/p/b3287b1ce3f9)

#flowbook/3 #flowbook/message